{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}My Support Tickets - Empower Recovery{% endblock %}

{% block content %}
<section class="py-5">
    <div class="container">
        <div class="row mb-4">
            <div class="col-lg-8">
                <h1>My Support Tickets</h1>
                <p class="text-muted">Track and manage your support requests</p>
            </div>
            <div class="col-lg-4 text-end">
                <a href="{% url 'support:create_ticket' %}" class="btn btn-primary">
                    <i class="fas fa-plus me-2"></i>New Ticket
                </a>
            </div>
        </div>

        <!-- Search and Filter -->
        <div class="row mb-4">
            <div class="col-12">
                <form method="get" class="d-flex flex-wrap gap-2 align-items-end">
                    <div class="flex-grow-1" style="min-width: 250px;">
                        <label for="search" class="form-label small text-muted mb-1">Search tickets</label>
                        <input type="text" class="form-control" id="search" name="search" 
                               placeholder="Search by subject, ID, or description..." 
                               value="{{ request.GET.search }}">
                    </div>
                    <div style="min-width: 120px;">
                        <label for="status" class="form-label small text-muted mb-1">Status</label>
                        <select class="form-select" id="status" name="status">
                            <option value="">All Status</option>
                            <option value="open" {% if request.GET.status == 'open' %}selected{% endif %}>Open</option>
                            <option value="in_progress" {% if request.GET.status == 'in_progress' %}selected{% endif %}>In Progress</option>
                            <option value="resolved" {% if request.GET.status == 'resolved' %}selected{% endif %}>Resolved</option>
                            <option value="closed" {% if request.GET.status == 'closed' %}selected{% endif %}>Closed</option>
                        </select>
                    </div>
                    <div style="min-width: 120px;">
                        <label for="priority" class="form-label small text-muted mb-1">Priority</label>
                        <select class="form-select" id="priority" name="priority">
                            <option value="">All Priority</option>
                            <option value="low" {% if request.GET.priority == 'low' %}selected{% endif %}>Low</option>
                            <option value="medium" {% if request.GET.priority == 'medium' %}selected{% endif %}>Medium</option>
                            <option value="high" {% if request.GET.priority == 'high' %}selected{% endif %}>High</option>
                            <option value="critical" {% if request.GET.priority == 'critical' %}selected{% endif %}>Critical</option>
                        </select>
                    </div>
                    <div style="min-width: 150px;">
                        <label for="category" class="form-label small text-muted mb-1">Category</label>
                        <select class="form-select" id="category" name="category">
                            <option value="">All Categories</option>
                            <option value="account" {% if request.GET.category == 'account' %}selected{% endif %}>Account Issues</option>
                            <option value="technical" {% if request.GET.category == 'technical' %}selected{% endif %}>Technical Support</option>
                            <option value="billing" {% if request.GET.category == 'billing' %}selected{% endif %}>Billing</option>
                            <option value="feature" {% if request.GET.category == 'feature' %}selected{% endif %}>Feature Request</option>
                            <option value="bug" {% if request.GET.category == 'bug' %}selected{% endif %}>Bug Report</option>
                            <option value="other" {% if request.GET.category == 'other' %}selected{% endif %}>Other</option>
                        </select>
                    </div>
                    <div class="d-flex gap-1">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-search"></i><span class="d-none d-sm-inline ms-1">Search</span>
                        </button>
                        <a href="{% url 'support:ticket_list' %}" class="btn btn-outline-secondary">
                            <i class="fas fa-times"></i><span class="d-none d-sm-inline ms-1">Clear</span>
                        </a>
                    </div>
                </form>
            </div>
        </div>

        <!-- Tickets List -->
        <div class="row">
            <div class="col-lg-12">
                {% if page_obj %}
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            Support Tickets 
                            <span class="badge bg-secondary">{{ total_tickets }} total</span>
                        </h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Ticket ID</th>
                                        <th>Subject</th>
                                        <th>Category</th>
                                        <th>Priority</th>
                                        <th>Status</th>
                                        <th>Responses</th>
                                        <th>Created</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for ticket in page_obj %}
                                    <tr>
                                        <td>
                                            <strong class="text-primary">{{ ticket.ticket_id }}</strong>
                                        </td>
                                        <td>
                                            <div>
                                                <strong>{{ ticket.subject|truncatechars:40 }}</strong>
                                                {% if ticket.assigned_to %}
                                                <br><small class="text-muted">
                                                    <i class="fas fa-user me-1"></i>{{ ticket.assigned_to.get_full_name }}
                                                </small>
                                                {% endif %}
                                            </div>
                                        </td>
                                        <td>
                                            <span class="badge bg-primary">{{ ticket.get_category_display }}</span>
                                        </td>
                                        <td>
                                            <span class="badge bg-{% if ticket.priority == 'critical' %}danger{% elif ticket.priority == 'high' %}warning{% elif ticket.priority == 'medium' %}primary{% else %}success{% endif %}">
                                                {{ ticket.get_priority_display }}
                                            </span>
                                        </td>
                                        <td>
                                            <span class="badge bg-{% if ticket.status == 'open' %}primary{% elif ticket.status == 'closed' %}secondary{% elif ticket.status == 'resolved' %}success{% elif ticket.status == 'in_progress' %}info{% else %}warning{% endif %}">
                                                {{ ticket.get_status_display }}
                                            </span>
                                        </td>
                                        <td>
                                            <span class="badge bg-secondary">{{ ticket.response_count }}</span>
                                        </td>
                                        <td>
                                            <small>{{ ticket.created_at|date:"M d, Y" }}<br>{{ ticket.created_at|time:"H:i" }}</small>
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <a href="{% url 'support:ticket_detail' ticket.ticket_id %}" class="btn btn-outline-primary" title="View Details">
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                                {% if ticket.is_open %}
                                                <form method="post" action="{% url 'support:close_ticket' ticket.ticket_id %}" style="display: inline;">
                                                    {% csrf_token %}
                                                    <button type="submit" class="btn btn-outline-secondary" title="Close Ticket" onclick="return confirm('Are you sure you want to close this ticket?')">
                                                        <i class="fas fa-times"></i>
                                                    </button>
                                                </form>
                                                {% endif %}
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Pagination -->
                {% if page_obj.has_other_pages %}
                <div class="d-flex justify-content-center mt-4">
                    <nav>
                        <ul class="pagination">
                            {% if page_obj.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                    <i class="fas fa-chevron-left"></i> Previous
                                </a>
                            </li>
                            {% endif %}
                            
                            {% for num in page_obj.paginator.page_range %}
                            {% if page_obj.number == num %}
                            <li class="page-item active">
                                <span class="page-link">{{ num }}</span>
                            </li>
                            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ num }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">{{ num }}</a>
                            </li>
                            {% endif %}
                            {% endfor %}
                            
                            {% if page_obj.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_obj.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                    Next <i class="fas fa-chevron-right"></i>
                                </a>
                            </li>
                            {% endif %}
                        </ul>
                    </nav>
                </div>
                {% endif %}

                {% else %}
                <div class="card">
                    <div class="card-body text-center py-5">
                        <i class="fas fa-inbox fa-4x text-muted mb-4"></i>
                        <h4>No Support Tickets Found</h4>
                        <p class="text-muted">You haven't created any support tickets yet, or no tickets match your search criteria.</p>
                        <a href="{% url 'support:create_ticket' %}" class="btn btn-primary me-2">
                            <i class="fas fa-plus me-2"></i>Create Your First Ticket
                        </a>
                        <a href="?" class="btn btn-outline-secondary">
                            <i class="fas fa-refresh me-2"></i>Clear Filters
                        </a>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</section>
{% endblock %}